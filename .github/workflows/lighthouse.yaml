name: ÎùºÏù¥Ìä∏ÌïòÏö∞Ïä§ CI - developÏúºÎ°ú Ìë∏ÏãúÎêòÏóàÏùÑ Îïå Ï∏°Ï†ï

on:
  pull_request:
    branches: [develop]

jobs:
  lhci:
    name: Lighthouse Ï†êÏàò ÏûêÎèô Ï∏°Ï†ïÍ∏∞
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: './pokr-web'
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 16.18.0
        uses: actions/setup-node@v3
        with:
          node-version: 16.18.0

      - name: Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò
        run: |
          yarn

      - name: Ïõπ ÎπåÎìú
        run: |
          yarn build

      - name: Lighthouse CI Ïã§Ìñâ
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          npm install -g @lhci/cli
          lhci autorun || echo "Fail to Run Lighthouse CI!"

      - name: Ï†êÏàò Ìè¨Îß§ÌåÖ
        id: format_lighthouse_score
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const results = JSON.parse(
              fs.readFileSync('./pokr-web/lhci_reports/manifest.json'),
            );

            let comments = '';

            const formatResult = (res) => Math.round(res * 100);
            const score = (res) => (res >= 90 ? 'üü¢' : res >= 50 ? 'üü†' : 'üî¥');

            results.forEach((result) => {
              const { summary, jsonPath } = result;
              const details = JSON.parse(fs.readFileSync(jsonPath));
              const { audits } = details;

              Object.keys(summary).forEach(
                (key) => (summary[key] = formatResult(summary[key])),
              );

              const comment = [
                `‚ö°Ô∏è Lighthouse report!`,
                `| Category | Score |`,
                `| --- | --- |`,
                `| ${score(summary.performance)} Performance | ${summary.performance} |`,
              ].join('\n');

              const detail = [
                `| Category | Score |`,
                `| --- | --- |`,
                `| ${score(
                  audits['first-contentful-paint'].score * 100,
                )} First Contentful Paint | ${
                  audits['first-contentful-paint'].displayValue
                } |`,
              ].join('\n');
              comments += comment + '\n' + detail + '\n';
            });

            core.setOutput('comments', comments);

      - name: PRÏóê ÏΩîÎ©òÌä∏ Îã¨Í∏∞
        uses: unsplash/comment-on-pr@v1.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          msg: ${{ steps.format_lighthouse_score.outputs.comments}}
